@page "/"
@page "/{accountId:int}"
@using PFM.Website.Services
@using PFM.Website.Models
@using PFM.Website.Components.Dashboard

@inject BankAccountService BankAccountService
@inject ExpenseTypeService ExpenseTypeService
@inject NavigationManager NavigationManager

<AuthorizeView>
    <Authorized>

        <div class="row">
            <div class="col-lg-2" style="font-size: 12px; padding: 5px; border-radius: 5px;">
                <div class="row vignette purple">
                    <div class="col-lg-12">
                        @if (AvailableBankAccounts.Any())
                        {
                            <b><label>Accounts</label></b>
                            <select class="form-control" style="font-size: 12px;" value="@SelectedBankAccount?.Id" @onchange="@((e) => UpdateSelected(e))">
                                <option value=""></option>
                                @foreach (var bankAccount in @AvailableBankAccounts)
                                {
                                    <option value="@bankAccount.Id">@bankAccount.Name</option>
                                }
                            </select>
                            <br />
                            <b><label>Movements</label></b>
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/expenses/list/@SelectedBankAccount?.Id">Manage expenses</a>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/atm-withdraws/list/@SelectedBankAccount?.Id">Manage ATM Withdraws</a>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/incomes/list/@SelectedBankAccount?.Id">Manage incomes</a>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/savings/list/@SelectedBankAccount?.Id">Manage savings</a>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/" class="disabled">Import movements</a>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <b><label>Budget Plan</label></b>
                            <div class="ibox-content">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <a href="/" class="disabled">Manage budget plan</a>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning" role="alert">
                                To get started with your personal finance, create a <a href="/banks/create">bank</a> and <a href="/bank-accounts/create">bank account</a>.
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <LineChartExpenseOvertime @ref="LineChartExpenseOvertime" AccountId="@SelectedBankAccount?.Id"></LineChartExpenseOvertime>
            </div>
            <div class="col-lg-5">
                <BarChartMovementTypeOvertime @ref="BarChartMovementTypeOvertime" AccountId="@SelectedBankAccount?.Id"></BarChartMovementTypeOvertime>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-lg-2" style="font-size: 16px; padding: 5px; border-radius: 5px; color:white; text-align: right;">
                <VignetteMovementTypeSummary @ref="VignetteMovementTypeSummary" AccountId="@SelectedBankAccount?.Id" ></VignetteMovementTypeSummary>
            </div>
            <div class="col-lg-5">
                <PieChartExpenseTypeSummary @ref="PieChartExpenseTypeSummary" AccountId="@SelectedBankAccount?.Id" CategorySelected="UpdateChartsForCategory"></PieChartExpenseTypeSummary>
            </div>
            <div class="col-lg-5">
                Nothing here
            </div>
        </div>
        <hr />

        @if (SelectedCategory != null)
        {
            <b><label style="font-size:12px;">Details for '@SelectedCategory?.Name'</label></b>
        }
        <div class="row">
            <div class="col-lg-6">
                <BarChartExpenseTypeOvertime @ref="BarChartExpenseTypeOvertime" ExpenseTypeId="@SelectedCategory?.Id" AccountId="@SelectedBankAccount?.Id"></BarChartExpenseTypeOvertime>
            </div>
            <div class="col-lg-6">
                <TableExpenseByType @ref="TableExpenseByType" ExpenseTypeId="@SelectedCategory?.Id" AccountId="@SelectedBankAccount?.Id"></TableExpenseByType>
            </div>
        </div>

    </Authorized>
</AuthorizeView>


@code {

    [Parameter]
    public int? AccountId { get; set; }

    private BankAccountListModel? SelectedBankAccount;
    private IList<BankAccountListModel> AvailableBankAccounts = new List<BankAccountListModel>();
    private IList<ExpenseTypeModel> DisplayedCategories;
    private ExpenseTypeModel? SelectedCategory;

    protected TableExpenseByTypeBase TableExpenseByType { get; set; }
    protected BarChartExpenseTypeOvertimeBase BarChartExpenseTypeOvertime { get; set; }
    protected VignetteMovementTypeSummaryBase VignetteMovementTypeSummary { get; set; }
    protected PieChartExpenseTypeSummaryBase PieChartExpenseTypeSummary { get; set; }
    protected LineChartExpenseOvertimeBase LineChartExpenseOvertime { get; set; }
    protected BarChartMovementTypeOvertimeBase BarChartMovementTypeOvertime { get; set; }

    protected override async Task OnInitializedAsync()
    {
        SelectedBankAccount = await BankAccountService.GetCurrentAccount(AccountId);
        AvailableBankAccounts = await BankAccountService.GetAll();
    }

    protected async Task UpdateSelected(ChangeEventArgs referenced)
    {
        var id = Convert.ToInt32(referenced.Value);
        SelectedCategory = null;
        NavigationManager.NavigateTo($"/{id}", true);
    }

    public async Task UpdateChartsForCategory(ExpenseTypeModel category)
    {
        await BarChartExpenseTypeOvertime.ReloadComponent(category.Id.Value);
        await TableExpenseByType.ReloadComponent(category.Id.Value);
        SelectedCategory = category;
        this.StateHasChanged();
    }
}
